<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Translator</title>
    <style>
        :root { --primary: #007aff; --bg: #ffffff; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #d2d2d7; box-sizing: border-box; font-size: 14px; background: #f5f5f7; margin-bottom: 24px; }
        .main { display: flex; flex-direction: column; align-items: center; margin-bottom: 40px; }
        #btn { background: var(--primary); color: white; border: none; width: 72px; height: 72px; border-radius: 50%; font-size: 28px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #btn.rec { background: #ff3b30; transform: scale(1.1); box-shadow: 0 0 15px rgba(255,59,48,0.5); }
        #status { margin-top: 12px; font-size: 13px; color: #86868b; }
        h3 { font-size: 18px; border-bottom: 1px solid #d2d2d7; padding-bottom: 8px; display: flex; justify-content: space-between; }
        .item { border-bottom: 1px solid #f5f5f7; padding: 12px 0; }
        .label { font-size: 10px; font-weight: bold; color: #86868b; text-transform: uppercase; }
        .in { font-size: 15px; margin-bottom: 4px; color: #000; }
        .out { font-size: 17px; color: var(--primary); font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <input type="password" id="key" placeholder="OpenAI Key">
        <div class="main">
            <button id="btn">ðŸŽ¤</button>
            <div id="status">Tap to start</div>
        </div>
        <h3>History <span style="font-size:12px; color:#ff3b30; cursor:pointer" onclick="clearH()">Clear</span></h3>
        <div id="list"></div>
    </div>

    <script>
        let rec; let chunks = [];
        const btn = document.getElementById('btn');
        const list = document.getElementById('list');

        window.onload = () => {
            render();
            if(localStorage.getItem('k')) document.getElementById('key').value = localStorage.getItem('k');
        };

        btn.onclick = async () => {
            const k = document.getElementById('key').value;
            if(!k) return alert("Enter Key");
            localStorage.setItem('k', k);

            if(rec && rec.state === "recording") { 
                rec.stop(); 
                return; 
            }

            try {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                // ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹å½¢å¼ã‚’è‡ªå‹•é¸æŠž
                const type = MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : 'audio/mp4';
                rec = new MediaRecorder(s, { mimeType: type });
                
                chunks = [];
                rec.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                rec.onstop = async () => {
                    btn.classList.remove('rec'); btn.innerText = "ðŸŽ¤";
                    const blob = new Blob(chunks, { type: rec.mimeType });
                    process(blob, k);
                };
                rec.start();
                btn.classList.add('rec'); btn.innerText = "â– ";
                document.getElementById('status').innerText = "Recording...";
            } catch(e) { alert("Mic error: " + e.message); }
        };

        async function process(blob, k) {
            if (blob.size < 1000) { // æ¥µç«¯ã«å°ã•ã„ãƒ‡ãƒ¼ã‚¿ã¯ç„¡è¦–
                document.getElementById('status').innerText = "Too short or silent";
                return;
            }

            try {
                document.getElementById('status').innerText = "Transcribing...";
                
                const fd = new FormData();
                // æ‹¡å¼µå­ã‚’é©åˆ‡ã«è¨­å®š
                const ext = rec.mimeType.includes('webm') ? 'webm' : 'm4a';
                fd.append("file", blob, `audio.${ext}`);
                fd.append("model", "whisper-1");
                fd.append("language", "ja");

                const stt = await fetch("https://api.openai.com/v1/audio/transcriptions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}` }, body: fd
                });
                const sttD = await stt.json();
                const jp = sttD.text;

                if(!jp || jp.trim().length === 0) {
                    document.getElementById('status').innerText = "Could not hear you";
                    return;
                }

                const id = Date.now();
                list.insertAdjacentHTML('afterbegin', `<div class="item" id="${id}"><div class="label">In</div><div class="in">${jp}</div><div class="label">Out</div><div class="out" id="out-${id}">...</div></div>`);

                document.getElementById('status').innerText = "Translating...";
                const gpt = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "gpt-4o-mini", messages: [{role:"system",content:"Translate to English."}, {role:"user",content:jp}] })
                });
                const gptD = await gpt.json();
                const en = gptD.choices[0].message.content;

                document.getElementById(`out-${id}`).innerText = en;

                const tts = await fetch("https://api.openai.com/v1/audio/speech", {
                    method: "POST", headers: { "Authorization": `Bearer ${k}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "tts-1", voice: "alloy", input: en })
                });
                const audio = new Audio(URL.createObjectURL(await tts.blob()));
                audio.play();

                const h = JSON.parse(localStorage.getItem('h') || '[]');
                h.unshift({ jp, en